name: Playwright Tests
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_mobile_only:
        description: 'Run only mobile compatibility tests'
        required: false
        default: false
        type: boolean
env:
  NODE_VERSION: 20.x
  NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
  NUXT_AUTH_GITHUB: ${{ vars.NUXT_AUTH_GITHUB }}
  APP_ENV: ${{ vars.APP_ENV }}
jobs:
  test:
    if: ${{ !inputs.test_mobile_only }}
    timeout-minutes: 30
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, "Mobile Chrome"]
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-node@v5
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}-${{ matrix.project }}
        restore-keys: |
          ${{ runner.os }}-playwright-${{ matrix.project }}-
          ${{ runner.os }}-playwright-
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium webkit
    - name: Install Mobile Browser Dependencies
      run: |
        # Install additional dependencies for mobile browser emulation
        sudo apt-get update
        sudo apt-get install -y fonts-liberation fonts-noto-color-emoji fonts-noto-cjk
    - name: Run Playwright tests for ${{ matrix.project }}
      run: npx playwright test --project="${{ matrix.project }}"
      env:
        NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
        NUXT_AUTH_GITHUB: ${{ vars.NUXT_AUTH_GITHUB }}
        APP_ENV: test
        CI: true
    - name: Upload Playwright Report for ${{ matrix.project }}
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report-${{ matrix.project }}
        path: playwright-report/
        retention-days: 7

  mobile-compatibility:
    name: Mobile Compatibility Tests
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-node@v5
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-mobile-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-mobile-
          ${{ runner.os }}-playwright-
    - name: Install Playwright Browsers for Mobile Testing
      run: npx playwright install --with-deps chromium webkit
    - name: Install Mobile Browser Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-liberation fonts-noto-color-emoji fonts-noto-cjk
    - name: Run Mobile Compatibility Tests
      run: npx playwright test mobile-compatibility.spec.ts
      env:
        NUXT_SESSION_PASSWORD: ${{ secrets.NUXT_SESSION_PASSWORD }}
        NUXT_AUTH_GITHUB: ${{ vars.NUXT_AUTH_GITHUB }}
        APP_ENV: test
        CI: true
    - name: Upload Mobile Compatibility Report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: mobile-compatibility-report
        path: playwright-report/
        retention-days: 7

  summary:
    name: Test Summary
    if: always()
    needs: [test, mobile-compatibility]
    runs-on: ubuntu-latest
    steps:
    - name: Check test results
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test.result }}" == "success" || "${{ needs.test.result }}" == "skipped" ]]; then
          echo "✅ **Cross-Browser Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Cross-Browser Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.mobile-compatibility.result }}" == "success" ]]; then
          echo "✅ **Mobile Compatibility Tests**: ${{ needs.mobile-compatibility.result }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Mobile Compatibility Tests**: ${{ needs.mobile-compatibility.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Mobile Browsers Tested:" >> $GITHUB_STEP_SUMMARY
        echo "- 📱 **Mobile Chrome (Pixel 5)**: Emulated mobile Chrome experience" >> $GITHUB_STEP_SUMMARY
        echo "- 📱 **Mobile Safari (iPhone 12)**: Emulated mobile Safari experience" >> $GITHUB_STEP_SUMMARY
        echo "- 🖥️ **Desktop Chrome**: With touch support enabled" >> $GITHUB_STEP_SUMMARY
        echo "- 🖥️ **Desktop Safari**: With touch support enabled" >> $GITHUB_STEP_SUMMARY